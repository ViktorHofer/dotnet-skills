name: Eval

on:
  pull_request:
    paths:
      - 'src/**'
      - 'eng/evaluation/**'
      - '.github/workflows/eval.yml'

  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes

  workflow_dispatch:
    inputs:
      plugins:
        description: 'Plugins to evaluate (comma-separated, empty=all with testcases)'
        required: false
        default: ''
      scenarios:
        description: 'Scenarios to test (comma-separated, empty=all)'
        required: false
        default: ''
      skip_vanilla:
        description: 'Skip vanilla comparison (faster testing)'
        required: false
        type: boolean
        default: false
      parallelism:
        description: 'Number of scenarios to run in parallel'
        required: false
        type: number
        default: 4


concurrency:
  # PRs: cancel previous runs on same branch. Schedule/dispatch: unique group per run (never cancel).
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.ref || github.run_id }}
  cancel-in-progress: true

# Note: For local testing with act, secrets are loaded from .secrets file
# For GitHub, secrets are configured in repository settings
env:
  GH_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
  RESULTS_BASE: artifacts/TestResults

permissions:
  contents: write
  pull-requests: write

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      plugins: ${{ steps.find.outputs.plugins }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find plugins with testcases
        id: find
        run: |
          $input = "${{ github.event.inputs.plugins }}"
          if ($input) {
            $plugins = $input -split ',' | ForEach-Object { $_.Trim() }
          } else {
            $plugins = Get-ChildItem -Path "src" -Directory |
              Where-Object { Test-Path (Join-Path $_.FullName "testcases") } |
              Select-Object -ExpandProperty Name
          }

          $json = $plugins | ConvertTo-Json -Compress
          # Ensure it's always an array
          if ($plugins.Count -eq 1) { $json = "[$json]" }
          Write-Host "Plugins to evaluate: $json"
          echo "plugins=$json" >> $env:GITHUB_OUTPUT
        shell: pwsh

  evaluate:
    needs: discover
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        plugin: ${{ fromJson(needs.discover.outputs.plugins) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Copilot CLI
        run: |
          npm install -g @github/copilot
          copilot --version

      - name: Create results directory
        run: |
          $runId = Get-Date -Format 'yyyyMMdd-HHmmss'
          $resultsDir = "$env:RESULTS_BASE/${{ matrix.plugin }}"
          New-Item -ItemType Directory -Force -Path $resultsDir
          echo "RUN_ID=$runId" >> $env:GITHUB_ENV
          echo "RESULTS_DIR=$resultsDir" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Discover scenarios
        run: |
          $inputScenarios = "${{ github.event.inputs.scenarios }}"
          if ($inputScenarios) {
            $scenarios = $inputScenarios -split ',' | ForEach-Object { $_.Trim() }
          }
          else {
            $scenarios = Get-ChildItem -Path "src/${{ matrix.plugin }}/testcases" -Directory |
              Where-Object { Test-Path (Join-Path $_.FullName "expected-output.md") } |
              Select-Object -ExpandProperty Name
          }
          $scenarioList = $scenarios -join ","
          Write-Host "Scenarios to evaluate for ${{ matrix.plugin }}: $scenarioList"
          echo "SCENARIOS=$scenarioList" >> $env:GITHUB_ENV

          # Set parallelism level
          $parallelism = "${{ github.event.inputs.parallelism }}"
          if (-not $parallelism -or $parallelism -eq '') {
            $parallelism = 4
          } else {
            try {
              $parallelism = [int]$parallelism
              if ($parallelism -lt 1) {
                Write-Warning "Parallelism must be at least 1, using default of 4"
                $parallelism = 4
              }
            } catch {
              Write-Warning "Invalid parallelism value, using default of 4"
              $parallelism = 4
            }
          }
          Write-Host "Parallelism level: $parallelism"
          echo "PARALLELISM=$parallelism" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Run Vanilla Copilot (no plugins)
        if: ${{ github.event.inputs.skip_vanilla != 'true' }}
        run: |
          $plugin = "${{ matrix.plugin }}"

          # Ensure plugin is not installed (ignore error if not installed)
          $ErrorActionPreference = "SilentlyContinue"
          copilot plugin uninstall $plugin 2>$null
          $ErrorActionPreference = "Stop"

          # Validate plugin state
          $pluginList = copilot plugin list 2>&1 | Out-String
          if ($pluginList -match "\b$plugin\b") {
            throw "❌ VALIDATION FAILED: $plugin should NOT be installed for vanilla run"
          }
          Write-Host "✅ Validated: No $plugin plugin installed"

          # Run scenarios in parallel
          $scenarios = $env:SCENARIOS -split ","
          $parallelism = [int]$env:PARALLELISM
          $resultsDir = $env:RESULTS_DIR
          $runId = $env:RUN_ID
          Write-Host "`nRunning $($scenarios.Count) scenarios with parallelism level: $parallelism"

          $scenarios | ForEach-Object -ThrottleLimit $parallelism -Parallel {
            $scenario = $_
            $plugin = $using:plugin
            $resultsDir = $using:resultsDir
            $runId = $using:runId
            Write-Host "`n=== Running vanilla: $scenario ==="
            pwsh -File ./eng/evaluation/run-scenario.ps1 `
              -ScenarioName $scenario `
              -RunType "vanilla" `
              -ResultsDir $resultsDir `
              -RunId $runId `
              -PluginName $plugin `
              -MarketplaceName "dotnet-skills" `
              -ScenariosBaseDir "src/$plugin/testcases"
          }

          Write-Host "`n✅ All vanilla scenario runs completed"
        shell: pwsh

      - name: Install Plugin and Run Skilled Copilot
        run: |
          $plugin = "${{ matrix.plugin }}"

          # Register the repo checkout as a local plugin marketplace
          $repoRoot = "${{ github.workspace }}"
          Write-Host "Registering marketplace from: $repoRoot"
          Write-Host "Marketplace config exists: $(Test-Path (Join-Path $repoRoot '.github/plugin/marketplace.json'))"
          copilot plugin marketplace add $repoRoot 2>&1 | Write-Host

          # Browse available plugins
          Write-Host "`nAvailable plugins in marketplace:"
          copilot plugin marketplace browse dotnet-skills 2>&1 | Write-Host

          # Install the plugin from the marketplace
          Write-Host "`nInstalling $plugin plugin..."
          copilot plugin install "$plugin@dotnet-skills" 2>&1 | Write-Host

          # Validate plugin is installed
          $pluginList = copilot plugin list 2>&1 | Out-String
          if ($pluginList -notmatch "\b$plugin\b") {
            throw "❌ VALIDATION FAILED: $plugin should be installed for skilled run"
          }
          Write-Host "✅ Validated: $plugin plugin is installed"

          # Run scenarios in parallel
          $scenarios = $env:SCENARIOS -split ","
          $parallelism = [int]$env:PARALLELISM
          $resultsDir = $env:RESULTS_DIR
          $runId = $env:RUN_ID
          Write-Host "`nRunning $($scenarios.Count) scenarios with parallelism level: $parallelism"

          $scenarios | ForEach-Object -ThrottleLimit $parallelism -Parallel {
            $scenario = $_
            $resultsDir = $using:resultsDir
            $runId = $using:runId
            $plugin = $using:plugin
            Write-Host "`n=== Running skilled: $scenario ==="
            pwsh -File ./eng/evaluation/run-scenario.ps1 `
              -ScenarioName $scenario `
              -RunType "skilled" `
              -ResultsDir $resultsDir `
              -RunId $runId `
              -PluginName $plugin `
              -MarketplaceName "dotnet-skills" `
              -ScenariosBaseDir "src/$plugin/testcases"
          }

          Write-Host "`n✅ All skilled scenario runs completed"
        shell: pwsh

      - name: Uninstall Plugin and Run Evaluation
        run: |
          $plugin = "${{ matrix.plugin }}"

          # Uninstall plugin for clean evaluation (ignore error if not installed)
          $ErrorActionPreference = "SilentlyContinue"
          copilot plugin uninstall $plugin 2>$null
          $ErrorActionPreference = "Stop"

          # Validate plugin is removed
          $pluginList = copilot plugin list 2>&1 | Out-String
          if ($pluginList -match "\b$plugin\b") {
            throw "❌ VALIDATION FAILED: $plugin should NOT be installed for evaluation"
          }
          Write-Host "✅ Validated: No $plugin plugin installed for evaluation"

          # Evaluate scenarios in parallel
          $scenarios = $env:SCENARIOS -split ","
          $parallelism = [int]$env:PARALLELISM
          $resultsDir = $env:RESULTS_DIR
          $runId = $env:RUN_ID
          Write-Host "`nEvaluating $($scenarios.Count) scenarios with parallelism level: $parallelism"

          $scenarios | ForEach-Object -ThrottleLimit $parallelism -Parallel {
            $scenario = $_
            $resultsDir = $using:resultsDir
            $runId = $using:runId
            $plugin = $using:plugin
            Write-Host "`n=== Evaluating: $scenario ==="
            pwsh -File ./eng/evaluation/evaluate-response.ps1 `
              -ScenarioName $scenario `
              -ResultsDir $resultsDir `
              -RunId $runId `
              -ScenariosBaseDir "src/$plugin/testcases"
          }

          Write-Host "`n✅ All scenario evaluations completed"
        shell: pwsh

      - name: Upload Artifacts
        id: upload-artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.plugin }}
          path: ${{ env.RESULTS_BASE }}/${{ matrix.plugin }}/
          retention-days: 30

      - name: Generate Summary
        if: always()
        run: |
          pwsh -File ./eng/evaluation/generate-summary.ps1 `
            -ResultsDir "$env:RESULTS_DIR" `
            -RunId "$env:RUN_ID" `
            -PluginName "${{ matrix.plugin }}" `
            -GitHubRunUrl "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" `
            -ArtifactsUrl "${{ steps.upload-artifacts.outputs.artifact-url }}"

          # Add to job summary
          Get-Content "$env:RESULTS_DIR/summary.md" >> $env:GITHUB_STEP_SUMMARY
        shell: pwsh

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        continue-on-error: true
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: ${{ env.RESULTS_DIR }}/summary.md

  publish-benchmark:
    needs: evaluate
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download evaluation artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.RESULTS_BASE }}/

      - name: Fetch existing benchmark data
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          mkdir -p /tmp/gh-pages/data
          # Copy all existing per-plugin JSON files and manifest
          for f in $(git ls-tree --name-only gh-pages:data 2>/dev/null); do
            git show "gh-pages:data/$f" > "/tmp/gh-pages/data/$f" 2>/dev/null || true
          done

      - name: Generate Benchmark Data
        run: |
          $commitJson = @{
            id        = "${{ github.sha }}"
            message   = $env:COMMIT_MSG
            timestamp = "${{ github.event.head_commit.timestamp }}"
            url       = "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
            author    = @{ name = "${{ github.event.head_commit.author.name }}"; username = "${{ github.actor }}" }
          } | ConvertTo-Json -Compress

          # Generate benchmark data for each plugin
          # Layout: artifacts/TestResults/<plugin>/<scenario>/<runId>/
          $pluginDirs = Get-ChildItem -Path "$env:RESULTS_BASE" -Directory -ErrorAction SilentlyContinue
          foreach ($pluginDir in $pluginDirs) {
            $plugin = $pluginDir.Name

            # Detect the runId from the first scenario's subdirectory
            $firstScenario = Get-ChildItem -Path $pluginDir.FullName -Directory | Select-Object -First 1
            if (-not $firstScenario) {
              Write-Warning "No scenario results found for $plugin, skipping"
              continue
            }
            $runIdDir = Get-ChildItem -Path $firstScenario.FullName -Directory | Select-Object -First 1
            if (-not $runIdDir) {
              Write-Warning "No run results found for $plugin/$($firstScenario.Name), skipping"
              continue
            }
            $runId = $runIdDir.Name

            Write-Host "`n=== Generating benchmark data for: $plugin (run: $runId) ==="
            $existingFile = "/tmp/gh-pages/data/$plugin.json"
            $params = @{
              ResultsDir = $pluginDir.FullName
              PluginName = $plugin
              RunId      = $runId
              OutputDir  = "/tmp/gh-pages/data"
              CommitJson = $commitJson
            }
            if ((Test-Path $existingFile) -and (Get-Content $existingFile -Raw -ErrorAction SilentlyContinue)) {
              $params.ExistingDataFile = $existingFile
            }
            & ./eng/dashboard/generate-benchmark-data.ps1 @params
          }

          # Generate plugins.json manifest from all per-plugin JSON files
          $plugins = Get-ChildItem -Path "/tmp/gh-pages/data" -Filter "*.json" -File -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -ne "plugins.json" } |
            ForEach-Object { $_.BaseName }
          @($plugins) | ConvertTo-Json | Out-File -FilePath "/tmp/gh-pages/data/plugins.json" -Encoding utf8
          Write-Host "`n=== plugins.json: $($plugins -join ', ') ==="
        shell: pwsh
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}

      - name: Deploy to GitHub Pages
        run: |
          cd /tmp
          REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

          # Clone existing gh-pages or create new branch
          if git ls-remote --exit-code --heads "$REPO_URL" gh-pages > /dev/null 2>&1; then
            git clone --branch gh-pages --single-branch "$REPO_URL" deploy
          else
            mkdir deploy && cd deploy && git init && git checkout -b gh-pages
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            cd /tmp
          fi

          cd /tmp/deploy
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update files
          mkdir -p data
          cp /tmp/gh-pages/data/*.json data/
          cp ${{ github.workspace }}/eng/dashboard/dashboard.html index.html
          cp ${{ github.workspace }}/eng/dashboard/dashboard.js dashboard.js

          git add .
          git diff --cached --quiet && echo "No changes to deploy" && exit 0
          git commit -m "Update benchmark data"
          git push origin gh-pages
