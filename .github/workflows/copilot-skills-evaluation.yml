name: Copilot Skills Evaluation

on:
  pull_request:
    paths:
      - 'msbuild-skills/**'
      - 'evaluation/**'
      - '.github/workflows/copilot-skills-evaluation.yml'

  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC

  workflow_dispatch:
    inputs:
      scenarios:
        description: 'Scenarios to test (comma-separated, empty=all)'
        required: false
        default: ''
      skip_vanilla:
        description: 'Skip vanilla comparison (faster testing)'
        required: false
        type: boolean
        default: false

# Note: For local testing with act, secrets are loaded from .secrets file
# For GitHub, secrets are configured in repository settings
env:
  GH_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}

jobs:
  evaluate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install PowerShell
        uses: PSModule/Install-PowerShell@v1

      - name: Install Copilot CLI
        run: |
          if ! command -v copilot &> /dev/null; then
            npm install -g @github/copilot
          fi
          copilot --version

      - name: Create results directory
        run: |
          $runId = "${{ github.run_id }}-${{ github.run_attempt }}"
          New-Item -ItemType Directory -Force -Path "evaluation/results/$runId"
          echo "RUN_ID=$runId" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Discover scenarios
        id: discover
        run: |
          $inputScenarios = "${{ github.event.inputs.scenarios }}"
          if ($inputScenarios) {
            $scenarios = $inputScenarios -split ',' | ForEach-Object { $_.Trim() }
          }
          else {
            $scenarios = Get-ChildItem -Path "evaluation/scenarios" -Directory |
              Where-Object { Test-Path (Join-Path $_.FullName "scenario") } |
              Select-Object -ExpandProperty Name
          }
          $scenarioList = $scenarios -join ","
          Write-Host "Scenarios to evaluate: $scenarioList"
          echo "SCENARIOS=$scenarioList" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Run Vanilla Copilot (no plugins)
        if: ${{ github.event.inputs.skip_vanilla != 'true' }}
        run: |
          # Ensure no custom plugins are installed (ignore error if not installed)
          $ErrorActionPreference = "SilentlyContinue"
          copilot plugin uninstall msbuild-skills 2>$null
          $ErrorActionPreference = "Stop"

          # Validate plugin state
          $pluginList = copilot plugin list 2>&1 | Out-String
          if ($pluginList -match "msbuild-skills") {
            throw "❌ VALIDATION FAILED: msbuild-skills should NOT be installed for vanilla run"
          }
          Write-Host "✅ Validated: No msbuild-skills plugin installed"

          # Run each scenario
          $scenarios = $env:SCENARIOS -split ","
          foreach ($scenario in $scenarios) {
            Write-Host "`n=== Running vanilla: $scenario ==="
            pwsh -File ./evaluation/scripts/run-scenario.ps1 `
              -ScenarioName $scenario `
              -RunType "vanilla" `
              -ResultsDir "evaluation/results/$env:RUN_ID"
          }
        shell: pwsh

      - name: Install Plugin and Run Skilled Copilot
        run: |
          # Install the plugin from local source
          copilot plugin install "${{ github.workspace }}/msbuild-skills"

          # Validate plugin is installed
          $pluginList = copilot plugin list 2>&1 | Out-String
          if ($pluginList -notmatch "msbuild-skills") {
            throw "❌ VALIDATION FAILED: msbuild-skills should be installed for skilled run"
          }
          Write-Host "✅ Validated: msbuild-skills plugin is installed"

          # Run each scenario
          $scenarios = $env:SCENARIOS -split ","
          foreach ($scenario in $scenarios) {
            Write-Host "`n=== Running skilled: $scenario ==="
            pwsh -File ./evaluation/scripts/run-scenario.ps1 `
              -ScenarioName $scenario `
              -RunType "skilled" `
              -ResultsDir "evaluation/results/$env:RUN_ID"
          }
        shell: pwsh

      - name: Uninstall Plugin and Run Evaluation
        run: |
          # Uninstall plugin for clean evaluation (ignore error if not installed)
          $ErrorActionPreference = "SilentlyContinue"
          copilot plugin uninstall msbuild-skills 2>$null
          $ErrorActionPreference = "Stop"

          # Validate plugin is removed
          $pluginList = copilot plugin list 2>&1 | Out-String
          if ($pluginList -match "msbuild-skills") {
            throw "❌ VALIDATION FAILED: msbuild-skills should NOT be installed for evaluation"
          }
          Write-Host "✅ Validated: No msbuild-skills plugin installed for evaluation"

          # Evaluate each scenario
          $scenarios = $env:SCENARIOS -split ","
          foreach ($scenario in $scenarios) {
            Write-Host "`n=== Evaluating: $scenario ==="
            pwsh -File ./evaluation/scripts/evaluate-response.ps1 `
              -ScenarioName $scenario `
              -ResultsDir "evaluation/results/$env:RUN_ID"
          }
        shell: pwsh

      - name: Upload Artifacts
        id: upload-artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results-${{ env.RUN_ID }}
          path: evaluation/results/${{ env.RUN_ID }}/
          retention-days: 30

      - name: Generate Summary
        if: always()
        run: |
          pwsh -File ./evaluation/scripts/generate-summary.ps1 `
            -ResultsDir "evaluation/results/$env:RUN_ID" `
            -GitHubRunUrl "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" `
            -ArtifactsUrl "${{ steps.upload-artifacts.outputs.artifact-url }}"

          # Add to job summary
          Get-Content "evaluation/results/$env:RUN_ID/summary.md" >> $env:GITHUB_STEP_SUMMARY
        shell: pwsh

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        continue-on-error: true  # May fail in local act runs (no GitHub API)
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: evaluation/results/${{ env.RUN_ID }}/summary.md
