name: Copilot CLI Minimal Test

on:
  pull_request:
    paths:
      - 'msbuild-skills/**'
      - 'evaluation/**'
      - '.github/workflows/copilot-test-minimal.yml'
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Prompt to send to Copilot CLI'
        required: false
        default: 'What is 2 + 2? Answer with just the number.'

# Note: For local testing with act, secrets are loaded from .secrets file
# For GitHub, secrets are configured in repository settings
env:
  GH_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}

jobs:
  test-copilot:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Copilot CLI
        run: |
          npm install -g @github/copilot
          copilot --version

      - name: Test Copilot CLI
        id: copilot-test
        run: |
          PROMPT="${{ github.event.inputs.prompt || 'What is 2 + 2? Answer with just the number.' }}"
          echo "Testing Copilot CLI with prompt: $PROMPT"
          
          # Run copilot in programmatic mode
          copilot -p "$PROMPT" --no-ask-user 2>&1 | tee copilot-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          
          echo "=== Copilot Output ==="
          cat copilot-output.txt
          echo "=== End Output ==="
          echo "Exit Code: $EXIT_CODE"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code $EXIT_CODE"
            exit 1
          fi

      - name: Display Results
        run: |
          echo "=== Final Results ==="
          cat copilot-output.txt

      - name: Generate Summary
        id: summary
        run: |
          # Create a markdown summary
          cat > pr-comment.md << 'EOF'
          ## ðŸ¤– Copilot CLI Test Results
          
          **Prompt:** ${{ github.event.inputs.prompt || 'What is 2 + 2? Answer with just the number.' }}
          
          ### Output
          ```
          EOF
          
          cat copilot-output.txt >> pr-comment.md
          
          cat >> pr-comment.md << 'EOF'
          ```
          
          ---
          *Run ID: ${{ github.run_id }} | [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF
          
          echo "=== PR Comment Preview ==="
          cat pr-comment.md
          echo "=== End Preview ==="
          
          # Also add to job summary (visible on GitHub Actions page)
          cat pr-comment.md >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        continue-on-error: true  # May fail in local act runs (no GitHub API)
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: pr-comment.md

      - name: Upload Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: copilot-output
          path: |
            copilot-output.txt
            pr-comment.md
          retention-days: 7
